################################################################################
# This file was generated by Ansible for {{ansible_fqdn}}
# Do NOT modify this file by hand!
################################################################################

upstream {{ item.key }}_backend  {
{% for upstream in item.value.upstreams %}
    server {{upstream.backend_address}}:{{upstream.backend_port}};
{% endfor %}
}

server {
   listen         {{ item.value.listen | default(80) }};
   listen    [::]:{{ item.value.listen | default(80) }};
   server_name    {{ item.value.domains | join(' ') }};

   return         301 https://$server_name$request_uri;
}


server {
   listen        {{ item.value.listen_ssl | default(443) }} ssl http2;
   listen   [::]:{{ item.value.listen_ssl | default(443) }} ssl http2;

    proxy_pass                https://{{ item.key }}_backend;


   ssl_certificate /etc/letsencrypt/live/{{ item.key }}/fullchain.pem;
   ssl_certificate_key /etc/letsencrypt/live/{{ item.key }}/privkey.pem;

    ssl_trusted_certificate /etc/letsencrypt/live/{{ item.key }}/chain.pem;

   ssl_protocols TLSv1.3;


    ssl_session_timeout 1d;
    ssl_session_cache shared:MozSSL:10m;  # about 40000 sessions
    ssl_session_tickets off;

    ssl_prefer_server_ciphers off;


    ssl_stapling on;
    ssl_stapling_verify on;


{% if item.value.hsts_max_age is defined %}
   add_header Strict-Transport-Security "max-age={{ item.value.hsts_max_age }}; includeSubDomains; preload" always;
   {% else %}
      add_header Strict-Transport-Security "max-age=63072000" always;
{% endif %}

   server_name {{ item.value.domains | join(' ') }};

}
